name: Backend CI

on:
  push:
    branches: [main, develop]
    paths: ['backend/**']
  pull_request:
    branches: [main, develop]
    paths: ['backend/**']

permissions:
  contents: read
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: budgetbook_test
          POSTGRES_USER: budgetbook
          POSTGRES_PASSWORD: budgetbook
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Build
        run: ./gradlew build

      - name: Test
        run: ./gradlew test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/budgetbook_test
          SPRING_DATASOURCE_USERNAME: budgetbook
          SPRING_DATASOURCE_PASSWORD: budgetbook

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[CI FAIL] Backend - ${context.sha.substring(0, 7)}`;
            const body = [
              '## CI Failure Report',
              '',
              `**Workflow:** ${context.workflow}`,
              `**Branch:** ${context.ref}`,
              `**Commit:** ${context.sha}`,
              `**Author:** ${context.actor}`,
              `**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              '',
              '### Action Required',
              '- [ ] Backend teammate: 에러 로그 확인 후 수정',
              '- [ ] 수정 후 테스트 통과 확인',
              '',
              '> Label `ci-failure`로 Lead가 다음 세션에서 자동 감지합니다.',
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['ci-failure', 'backend'],
            });
