name: Frontend CI

on:
  push:
    branches: [main, develop]
    paths: ['frontend/**']
  pull_request:
    branches: [main, develop]
    paths: ['frontend/**']

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze

      - name: Test
        run: |
          if find test -name "*_test.dart" | grep -q .; then
            flutter test --no-pub
          else
            echo "No test files found, skipping"
          fi

      - name: Build Web
        run: flutter build web --release

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[CI FAIL] Frontend - ${context.sha.substring(0, 7)}`;
            const body = [
              '## CI Failure Report',
              '',
              `**Workflow:** ${context.workflow}`,
              `**Branch:** ${context.ref}`,
              `**Commit:** ${context.sha}`,
              `**Author:** ${context.actor}`,
              `**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              '',
              '### Action Required',
              '- [ ] Frontend teammate: 에러 로그 확인 후 수정',
              '- [ ] 수정 후 테스트 통과 확인',
              '',
              '> Label `ci-failure`로 Lead가 다음 세션에서 자동 감지합니다.',
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['ci-failure', 'frontend'],
            });
